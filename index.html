<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cortexa – Asistente | Neuropsicóloga Rodríguez</title>
  <link rel="icon" href="img/cerebro.png" type="image/png"/>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;700;800;900&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-WY5H8SE6RL"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-WY5H8SE6RL');
  </script>

  <style>
    :root{
      /* Paleta (azul/blanco) - misma identidad */
      --blue-900:#002b5c; /* cabecera */
      --blue-800:#003366; /* nav */
      --blue-700:#004a99; /* énfasis */
      --blue-600:#005bbf; 
      --blue-500:#2f6cb8;
      --sky-025:#f8fbff;
      --sky-050:#f5f9ff; 
      --sky-100:#eaf3ff;
      --white:#ffffff;
      --bot:#eef5ff;
      --user:#f7fbff;
      --accent:#66aaff;
      --ink:#1f3657;
      --muted:#5f7aa1;
      /* Efectos / layout */
      --radius:22px;
      --shadow-xl:0 22px 60px rgba(0,0,0,.16);
      --shadow-md:0 12px 28px rgba(0,0,0,.10);
      --glass:rgba(255,255,255,.78);
      --ring:0 0 0 3px #66aaff44;
      --border:#e2edff;
      --gridline:#dde9ff;
      --font-scale:1; /* accesibilidad: se modifica por controles */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Raleway',sans-serif;background:linear-gradient(135deg,var(--sky-050),#fff);color:var(--ink);font-size:calc(16px * var(--font-scale))}
    a{color:inherit}

    /* ===== HEADER (se mantiene) ===== */
    header{position:sticky;top:0;z-index:1000;background:linear-gradient(90deg,var(--blue-900),var(--blue-700));color:#fff;padding:16px 22px;box-shadow:var(--shadow-md)}
    .topbar{max-width:1200px;margin:auto;display:flex;align-items:center;gap:14px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .brand h1{font-size:28px;margin:0;letter-spacing:.6px}
    .quick{display:flex;gap:10px;opacity:.95}
    .quick a.social{display:inline-grid;place-items:center;width:40px;height:40px;border-radius:999px;background:rgba(255,255,255,.14);border:1.5px solid rgba(255,255,255,.28);color:#fff;text-decoration:none;box-shadow:0 8px 16px rgba(0,0,0,.12);transition:.25s;font-size:18px}
    .quick a.social:hover{background:#66b3ff;color:#002244}

    /* ===== NAV (se mantiene) ===== */
    nav{background:var(--blue-800)}
    .navlinks{max-width:1200px;margin:auto;display:flex;justify-content:center;gap:28px;padding:10px 0;flex-wrap:wrap}
    .navlinks a{color:#fff;text-decoration:none;background:rgba(255,255,255,.12);border:1.5px solid rgba(255,255,255,.28);border-radius:999px;padding:12px 20px;font-weight:800;font-size:1.05rem;transition:.3s;display:inline-flex;align-items:center;gap:8px}
    .navlinks a:hover{background:#66b3ff;color:#002244}
    @media (min-width:768px){.navlinks a{font-size:1.12rem;padding:14px 24px}}

    /* ===== COVER (pulida) ===== */
    .cover{position:relative;min-height:28vh;display:grid;place-items:center;color:#fff;text-align:center}
    .cover::before{content:"";position:absolute;inset:0;background:url('img/fondoazul.jpg') center/cover no-repeat;filter:brightness(.9)}
    .cover::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,29,61,.38) 0%,rgba(0,51,102,.78) 60%,rgba(0,51,102,.90) 100%)}
    .cover-inner{position:relative;z-index:1;padding:28px}
    .cover h2{margin:.2rem 0 .6rem;font-size:42px}
    .lead{opacity:.95}

    /* ===== LAYOUT NUEVO (cambio profundo visual) ===== */
    .container{max-width:1200px;margin:auto;padding:38px 16px}
    .chat-wrap{display:grid;grid-template-columns:1.1fr 360px;gap:24px;align-items:start}
    @media (max-width:980px){.chat-wrap{grid-template-columns:1fr}}

    /* ===== TARJETA CHAT: marco luminoso, patrón sutil, barra superior con controles ===== */
    .chat-card{position:relative;border-radius:30px;overflow:hidden;border:1px solid var(--border);box-shadow:var(--shadow-xl);background:var(--glass);backdrop-filter:blur(10px)}
    .chat-card::before{ /* borde animado sutil */
      content:"";position:absolute;inset:-1px;border-radius:32px;padding:1px;background:linear-gradient(135deg,transparent 30%,#b9d8ff 100%);
      -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none
    }
    .chat-topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);background:linear-gradient(90deg,var(--blue-900),var(--blue-700));color:#fff}
    .brand-ai{display:flex;align-items:center;gap:10px}
    .brand-ai .ava{width:38px;height:38px;border-radius:50%;display:grid;place-items:center;background:#fff;color:var(--blue-800);font-weight:900}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    .tool-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.15);color:#fff;font-weight:800;cursor:pointer}
    .tool-btn:hover{background:#66b3ff;color:#002244}

    /* fondo de chat con grid sutil */
    .chat-body{padding:18px;min-height:460px;max-height:64vh;overflow:auto;position:relative;background:
      linear-gradient(180deg,#ffffffd9,#ffffffb0),
      repeating-linear-gradient(0deg,transparent 0 28px, var(--gridline) 28px 29px),
      repeating-linear-gradient(90deg,transparent 0 28px, var(--gridline) 28px 29px)}
    .chat-body:focus{outline:none;box-shadow:var(--ring)}

    /* Separadores de día */
    .day-sep{display:flex;align-items:center;gap:12px;margin:18px 0;color:var(--muted);font-size:12px}
    .day-sep::before,.day-sep::after{content:"";flex:1;height:1px;background:var(--border)}

    /* Mensajes con agrupación por rol */
    .msg{display:flex;gap:10px;margin:10px 0;align-items:flex-start}
    .msg.user{flex-direction:row-reverse}
    .msg .ava{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;background:#e6f2ff;color:#004a99;font-weight:900;flex:0 0 32px}
    .cluster{display:flex;flex-direction:column;gap:6px;max-width:min(720px,92%)}
    .name{font-size:12px;color:var(--muted)}
    .bubble{position:relative;padding:12px 14px;border-radius:16px;line-height:1.55;color:var(--ink);background:#fff;border:1px solid var(--border);box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .msg.bot .bubble{background:linear-gradient(180deg,#f6faff,#eef6ff)}
    .msg.user .bubble{background:linear-gradient(180deg,#f9fcff,#ffffff)}
    .meta{font-size:11px;color:var(--muted)}

    /* Escribiendo */
    .typing{display:inline-flex;gap:6px;align-items:center}
    .dot{width:7px;height:7px;border-radius:50%;background:#8fb9ff;animation:blink 1.2s infinite ease-in-out}
    .dot:nth-child(2){animation-delay:.18s}.dot:nth-child(3){animation-delay:.36s}
    @keyframes blink{0%,80%,100%{opacity:.25;transform:translateY(0)}40%{opacity:1;transform:translateY(-2px)}}

    /* Composer y barra de sugerencias (nueva) */
    .composer{display:flex;flex-direction:column;gap:10px;padding:14px;background:linear-gradient(180deg,#f7fbff,#f3f8ff);border-top:1px solid var(--border)}
    .toolbar{display:flex;flex-wrap:nowrap;gap:8px;align-items:center;overflow:auto;padding-bottom:4px}
    .chip{white-space:nowrap;border:1.5px solid #cfe2ff;background:#eef6ff;color:#004a99;border-radius:999px;padding:8px 12px;font-weight:700;font-size:.92rem;cursor:pointer}
    .chip:hover{background:#66aaff;color:#002244}
    .chip.secondary{background:#f5f9ff}

    .inputrow{display:flex;gap:10px;align-items:flex-end}
    textarea{resize:none;flex:1;min-height:56px;max-height:180px;padding:12px 14px;border-radius:16px;border:1px solid #dce9ff;font-family:inherit;font-size:1rem;outline:none;box-shadow:0 6px 12px rgba(0,0,0,.04) inset}
    textarea:focus{box-shadow:var(--ring),0 6px 12px rgba(0,0,0,.04) inset}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{border:none;border-radius:14px;padding:12px 14px;font-weight:900;display:inline-flex;gap:8px;align-items:center;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--blue-700),var(--accent));color:#fff;box-shadow:0 10px 24px rgba(0,0,0,.14)}
    .btn.ghost{background:#f0f6ff;border:1px solid #cfe2ff;color:#003b86}
    .counter{font-size:12px;color:var(--muted)}

    /* Sidebar (se mantiene estilo base) */
    .side{background:#fff;border-radius:28px;box-shadow:var(--shadow-md);border:1px solid var(--border);padding:18px;position:sticky;top:92px}
    .side h3{margin:6px 0 12px;color:var(--blue-900)}
    .cta-mini{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 2px}
    .cta-mini a{text-decoration:none;border-radius:999px;padding:10px 14px;font-weight:800;display:inline-flex;align-items:center;gap:8px;border:1.5px solid #cfe2ff;background:#eef6ff;color:#004a99}
    .cta-mini a.primary{background:#66aaff;color:#002244}

    /* FAB scroll to bottom */
    .fab{position:fixed;right:22px;bottom:22px;z-index:999;border:none;border-radius:999px;padding:12px 14px;background:var(--blue-700);color:#fff;display:none;box-shadow:0 12px 26px rgba(0,0,0,.18);cursor:pointer}
    .fab.show{display:inline-flex}

    /* Alto contraste (toggle) */
    .hc .bubble{border-color:#7aa7ff}
    .hc .chat-body{background:linear-gradient(180deg,#ffffff,#f2f6ff)}
    .hc .tool-btn{border-color:#fff}

    /* Accesibilidad extra */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    @media (prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important}}
  </style>
</head>
<body>
  <!-- ===== HEADER (igual) ===== -->
  <header>
    <div class="topbar">
      <div class="brand"><h1>Neuropsicóloga Rodríguez</h1></div>
      <div class="quick">
        <a class="social" href="https://www.facebook.com/share/1Av2BgPo17/" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
        <a class="social" href="https://www.instagram.com/neuropsicologa_rodriguez_?igsh=NWZnNnphZTIzNWN6" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
      </div>
    </div>
  </header>

  <!-- ===== NAV (igual) ===== -->
  <nav>
    <div class="navlinks">
      <a href="index.html"><i class="fas fa-home"></i> Inicio</a>
      <a href="sobremi.html"><i class="fas fa-user"></i> Sobre Mí</a>
      <a href="reservarcita.html"><i class="fas fa-calendar-check"></i> Reservar Cita</a>
    </div>
  </nav>

  <!-- ===== COVER (pulida) ===== -->
  <section class="cover" aria-label="Presentación de Cortexa">
    <div class="cover-inner">
      <h2 style="margin-bottom:.2rem">Cortexa – Asistente Psicológico</h2>
      <p class="lead">Un espacio cercano, cálido y confidencial para hablar de lo que necesites.</p>
    </div>
  </section>

  <!-- ===== CHAT ===== -->
  <section class="container">
    <div class="chat-wrap">
      <!-- Panel principal -->
      <article class="chat-card" aria-live="polite" aria-label="Chat con Cortexa">
        <div class="chat-topbar">
          <div class="brand-ai"><div class="ava">🤖</div><strong>Cortexa</strong> <span style="opacity:.85;font-weight:500">· asistente</span></div>
          <div class="tools">
            <button id="clear" class="tool-btn" title="Limpiar chat"><i class="fa-solid fa-broom"></i> Limpiar</button>
            <button id="copyLast" class="tool-btn" title="Copiar última respuesta"><i class="fa-regular fa-copy"></i> Copiar</button>
            <button id="fontUp" class="tool-btn" title="Aumentar tamaño"><i class="fa-solid fa-plus"></i> Texto</button>
            <button id="fontDown" class="tool-btn" title="Reducir tamaño"><i class="fa-solid fa-minus"></i></button>
            <button id="contrast" class="tool-btn" title="Alto contraste"><i class="fa-solid fa-adjust"></i> Contraste</button>
          </div>
        </div>

        <div id="chat" class="chat-body" role="log" aria-label="Conversación">
          <div class="day-sep"><span>Hoy</span></div>
          <div class="msg bot">
            <div class="ava">🤖</div>
            <div class="cluster">
              <div class="name">Cortexa</div>
              <div class="bubble">Hola, soy Cortexa. Te escucho. ¿Qué te gustaría hablar hoy?</div>
              <div class="meta">Confidencial • Enter para enviar</div>
            </div>
          </div>
        </div>

        <!-- Composer con sugerencias -->
        <div class="composer">
          <div class="toolbar" aria-label="Sugerencias rápidas">
            <button class="chip" data-suggest="Tengo celos y no sé cómo hablarlo.">Celos</button>
            <button class="chip" data-suggest="Estoy con ansiedad y quiero técnicas rápidas.">Ansiedad</button>
            <button class="chip" data-suggest="Me cuesta concentrarme al estudiar.">Estudio</button>
            <button class="chip secondary" data-suggest="¿Cómo agendo una evaluación neuropsicológica?">Evaluación</button>
            <button class="chip secondary" data-suggest="Quiero mejorar mi comunicación en pareja.">Comunicación</button>
          </div>
          <div class="inputrow">
            <label class="sr-only" for="prompt">Escribe tu mensaje</label>
            <textarea id="prompt" placeholder="Escribe tu pregunta aquí…" rows="2" aria-label="Área de mensaje"></textarea>
            <div class="controls">
              <span id="count" class="counter">0 caracteres</span>
              <button id="send" class="btn primary"><i class="fa-solid fa-paper-plane"></i> Enviar</button>
              <button id="stop" class="btn ghost" title="Detener respuesta" style="display:none"><i class="fa-solid fa-stop"></i> Detener</button>
            </div>
          </div>
        </div>
      </article>

      <!-- Lateral (se mantiene con ligeros retoques) -->
      <aside class="side" aria-label="Ayuda y enlaces">
        <h3>¿Necesitas una cita?</h3>
        <p style="margin-top:0">Cortexa orienta; la atención profesional es con la Neuropsicóloga Rodríguez.</p>
        <div class="cta-mini">
          <a class="primary" href="reservarcita.html"><i class="fas fa-calendar-check"></i> Reservar cita</a>
          <a href="https://wa.me/51943748260" target="_blank" rel="noopener"><i class="fab fa-whatsapp"></i> WhatsApp</a>
        </div>
        <h3 style="margin-top:18px">Temas frecuentes</h3>
        <ul style="margin:6px 0 0 18px;color:#24415f;line-height:1.6">
          <li>Ansiedad, estrés, ánimo bajo y duelo</li>
          <li>Funciones ejecutivas, TDAH, aprendizaje</li>
          <li>Familia, pareja y convivencia</li>
          <li>Evaluación y rehabilitación neuropsicológica</li>
        </ul>
      </aside>
    </div>
  </section>

  <!-- Botón flotante para bajar al final -->
  <button id="toBottom" class="fab" title="Ir al final"><i class="fa-solid fa-arrow-down"></i></button>

  <script>
    // ======= CONFIG =======
    const BACKEND_URL = "https://cortexa-backend.cortexa.workers.dev"; // tu endpoint real
    const STORAGE_KEY = 'cortexa_chat_v2';
    const CHAT = document.getElementById("chat");
    const PROMPT = document.getElementById("prompt");
    const SEND = document.getElementById("send");
    const STOP = document.getElementById("stop");
    const CLEAR = document.getElementById("clear");
    const COPYLAST = document.getElementById("copyLast");
    const COUNT = document.getElementById("count");
    const FAB = document.getElementById("toBottom");
    const SESSION_ID = "demo-session"; // cámbialo por usuario/UUID si quieres

    // ======= Helpers =======
    const el = (html)=>{ const t=document.createElement("template"); t.innerHTML=html.trim(); return t.content.firstChild; };
    const scrollBottom = ()=>{ CHAT.scrollTop = CHAT.scrollHeight; };
    const nowTime = ()=> new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const todayLabel = ()=> new Date().toLocaleDateString();
    const sanitize = (text)=> String(text)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/\n/g,"<br>");

    function renderMessage(role, text){
      const node = el(`
        <div class="msg ${role}">
          <div class="ava">${role==='bot'?'🤖':'🗨️'}</div>
          <div class="cluster">
            <div class="name">${role==='bot'?'Cortexa':'Tú'}</div>
            <div class="bubble">${sanitize(text)}</div>
            <div class="meta">${nowTime()}</div>
          </div>
        </div>`);
      CHAT.appendChild(node);
    }

    function saveMessage(role, text){
      const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      data.push({role, text, t: Date.now()});
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadMessages(){
      const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      if(data.length){ CHAT.innerHTML = `<div class="day-sep"><span>${todayLabel()}</span></div>`; }
      data.forEach(m=> renderMessage(m.role, m.text));
      scrollBottom();
    }

    function clearChat(){
      localStorage.removeItem(STORAGE_KEY);
      CHAT.innerHTML = `<div class="day-sep"><span>Hoy</span></div>`;
      renderMessage('bot', 'Hola, soy Cortexa. Te escucho. ¿Qué te gustaría hablar hoy?');
      scrollBottom();
    }

    function copyLastBot(){
      const bubbles = CHAT.querySelectorAll('.msg.bot .bubble');
      const last = bubbles[bubbles.length-1];
      if(!last) return;
      const tmp = document.createElement('textarea');
      tmp.value = last.textContent; document.body.appendChild(tmp); tmp.select();
      document.execCommand('copy'); document.body.removeChild(tmp);
    }

    // Indicador de escritura
    let typingNode = null;
    function showTyping(){
      typingNode = el(`<div class="msg bot" id="typing"><div class="ava">🤖</div><div class="cluster"><div class="name">Cortexa</div><div class="bubble"><span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></div><div class="meta">Escribiendo…</div></div></div>`);
      CHAT.appendChild(typingNode); scrollBottom();
    }
    function hideTyping(){ if(typingNode && typingNode.parentNode){ typingNode.parentNode.removeChild(typingNode); typingNode=null; } }

    function setBusy(b){ SEND.disabled=b; PROMPT.disabled=b; STOP.style.display = b ? 'inline-flex' : 'none'; }

    // Auto-crecimiento y contador
    function autoGrow(){ PROMPT.style.height = 'auto'; PROMPT.style.height = Math.min(PROMPT.scrollHeight, 180)+"px"; COUNT.textContent = `${PROMPT.value.length} caracteres`; }
    PROMPT.addEventListener('input', autoGrow);

    // Sugerencias
    document.querySelectorAll('.chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{ PROMPT.value = ch.getAttribute('data-suggest'); autoGrow(); PROMPT.focus(); });
    });

    // ======= Networking =======
    async function askBackend(payload){
      const res = await fetch(BACKEND_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function handleSend(){
      const q = PROMPT.value.trim();
      if(!q) return;
      renderMessage('user', q); saveMessage('user', q);
      PROMPT.value = ""; autoGrow(); setBusy(true); showTyping();
      try{
        const { answer, error } = await askBackend({ question: q, sessionId: SESSION_ID });
        hideTyping();
        const text = error ? `⚠️ ${error}` : (answer || 'No pude generar una respuesta ahora.');
        renderMessage('bot', text); saveMessage('bot', text);
      }catch(e){
        hideTyping();
        const text = '⚠️ Error de conexión. Intenta de nuevo.';
        renderMessage('bot', text); saveMessage('bot', text);
      }finally{ setBusy(false); scrollBottom(); PROMPT.focus(); }
    }

    SEND.addEventListener("click", handleSend);
    PROMPT.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); handleSend(); }});

    // Botones topbar
    CLEAR.addEventListener('click', clearChat);
    COPYLAST.addEventListener('click', copyLastBot);
    document.getElementById('fontUp').addEventListener('click', ()=>{
      const s = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--font-scale')) || 1;
      document.documentElement.style.setProperty('--font-scale', Math.min(s+0.1, 1.6));
    });
    document.getElementById('fontDown').addEventListener('click', ()=>{
      const s = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--font-scale')) || 1;
      document.documentElement.style.setProperty('--font-scale', Math.max(s-0.1, 0.8));
    });
    document.getElementById('contrast').addEventListener('click', ()=>{
      document.body.classList.toggle('hc');
    });

    // FAB scroll bottom
    function toggleFab(){
      const nearBottom = CHAT.scrollHeight - CHAT.scrollTop - CHAT.clientHeight < 60;
      FAB.classList.toggle('show', !nearBottom);
    }
    CHAT.addEventListener('scroll', toggleFab);
    FAB.addEventListener('click', scrollBottom);

    // Inicializar
    (function init(){
      loadMessages();
      autoGrow();
      toggleFab();
    })();
  </script>
</body>
</html>